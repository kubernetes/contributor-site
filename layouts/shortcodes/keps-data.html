{{- $kepDataSourceUrl := "https://storage.googleapis.com/k8s-keps/keps.json" -}}
{{/*
  Datatables is used in the page to enrich the list of KEPs.
  The stylesheets and scripts required are in `partials/hooks/head-end.html`
  and `partials/hooks/body-end.html` respectively.

  Note: In order to configure Datatable parameters for changing any behavior, edit
  the `DataTable` initialization in `partials/hooks/body-end.html`

*/}}
{{- $kepData := "" -}}
{{- with resources.GetRemote $kepDataSourceUrl -}}
  {{- with .Err -}}
    {{- if eq hugo.Environment "production" }}
      {{ errorf "Unable to load KEP data: %s" . }}
    {{- else -}}
      {{- warnf "Cannot load KEP data: %s" . -}}
    {{- end -}}
  {{- else -}}
    {{- $kepData = .Content | transform.Unmarshal -}}
  {{- end -}}
{{- else -}}
  {{- if eq hugo.Environment "production" }}
    {{- errorf "Unable to load KEP data from %s" $kepDataSourceUrl -}}
  {{- else -}}
    {{- warnf "Cannot load KEP data from %s" $kepDataSourceUrl -}}
  {{- end -}}
{{- end -}}

{{/* Define stages that are "beyond provisional" for linking to internal pages */}}
{{- $validStages := slice "alpha" "beta" "stable" "deprecated" -}}
{{- $validStatuses := slice "implementable" "implemented" -}}

<div>
  <table id="keps-table" class="table table-hover mt-2 col-md-12 table-sm">
    <thead class="thead-light">
      <tr>
        <th scope="col" class="col-md-1">KEP Number</th>
        <th scope="col" class="col-md-3">Title</th>
        <th scope="col" class="col-md-2">SIG</th>
        <th scope="col" class="col-md-2">Author</th>
        <th scope="col" class="col-md-1">Created</th>
        <th scope="col" class="col-md-1">Last Updated</th>
        <th scope="col" class="col-md-1">Milestone</th>
      </tr>
    </thead>
    <tbody>
      {{range $index, $data := $kepData}}
          <tr>
            <td>
              <a href="https://kep.k8s.io/{{ $data.kepNumber }}">
                {{ printf "%s" $data.kepNumber }}
              </a>
            </td>
            <td>
              {{- $isValidStage := in $validStages $data.stage -}}
              {{- $isValidStatus := in $validStatuses $data.status -}}
              {{- if or $isValidStage $isValidStatus -}}
              <a href="/resources/keps/{{ $data.kepNumber }}/">
                {{ printf "%s" $data.title }}
              </a>
              {{- else -}}
              <a href="https://github.com/kubernetes/enhancements/tree/master/keps/{{$data.owningSig}}/{{$data.name}}#summary">
                {{ printf "%s" $data.title }}
              </a>
              {{- end -}}
            </td>
            <td>
              <a href=" https://github.com/kubernetes/community/tree/master/{{ $data.owningSig }}">
                {{ strings.TrimPrefix "sig-" $data.owningSig | humanize | title }}
              </a>
            </td>
            <td>
              {{ range $index, $author := $data.authors }}
              {{- if $index -}}, {{ end -}}
              <a href="https://github.com/{{ trim $author "@" }}">
                <span class="github-user">@{{ trim $author "@" }}</span>
              </a>
              {{ end }}
            </td>
            <td>
                {{ if $data.creationDate }}
                  <time datetime="{{ $data.creationDate }}">{{ $data.creationDate }}</time>
                {{ end }}
            </td>
            <td>
                {{ if $data.lastUpdated }}
                  <time datetime="{{ $data.lastUpdated }}">{{ $data.lastUpdated }}</time>
                {{ end }}
              </span>
            </td>
            <td>
              <ul class="list-unstyled">
                {{ range $stage, $milestone := $data.milestone }}
                  {{ if $milestone }}
                  <li>
                    {{ $stage }}:<span class="kep-milestone">{{ $milestone }}</span>
                  </li>
                  {{ end }}
                {{ end }}
              </ul>
            </td>
          </tr>
      {{ end }}
    </tbody>
  </table>
</div>
